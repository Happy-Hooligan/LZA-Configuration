##############################################################################################################
# Security Configuration for Landing Zone Accelerator on AWS                                                 #
# For detailed information about Included Services, Features, and Configuration References,                  #
# please review the SecurityConfig class reference in our TypeDoc:                                           #
# https://awslabs.github.io/landing-zone-accelerator-on-aws/latest/user-guide/config/#security-configuration #
#                                                                                                            #
# This is a minimal security configuration for test environment.                                             #
# - Core security services enabled (GuardDuty, SecurityHub, IAM Access Analyzer)                             #
# - Macie disabled (can enable later for sensitive data discovery)                                           #
# - EBS encryption and S3 public access block disabled for flexibility                                       #
# - Minimal Config rules (rely on SecurityHub NIST 800-53 R5 controls)                                       #
##############################################################################################################

###############################################################################################################
# Central Security Services Configuration                                                                     #
# These services are managed centrally from the delegated admin account (Audit/Config account).               #
###############################################################################################################
centralSecurityServices:
  delegatedAdminAccount: Audit # Maps to your CT Config account - manages security services org-wide

  #############################################################################################################
  # EBS Default Volume Encryption                                                                             #
  # DISABLED: Not enforcing encryption policy - developers need flexibility                                   #
  # Note: This setting enables account-level default encryption, not enforcement                              #
  #                                                                                                           #
  # To re-enable:                                                                                             #
  #   ebsDefaultVolumeEncryption:                                                                             #
  #     enable: true                                                                                          #
  #     excludeRegions: []                                                                                    #
  #############################################################################################################
  ebsDefaultVolumeEncryption:
    enable: false
    excludeRegions: []

  #############################################################################################################
  # S3 Public Access Block                                                                                    #
  # DISABLED: Developers need ability to create public S3 buckets                                             #
  # Note: Individual buckets can still have public access block enabled                                       #
  #                                                                                                           #
  # To re-enable:                                                                                             #
  #   s3PublicAccessBlock:                                                                                    #
  #     enable: true                                                                                          #
  #     excludeAccounts: []                                                                                   #
  #############################################################################################################
  s3PublicAccessBlock:
    enable: false
    excludeAccounts: []

  #############################################################################################################
  # SCP Revert Changes Configuration                                                                          #
  # Automatically reverts manual SCP changes made in the console back to LZA-defined state.                   #
  # Ensures SCPs remain consistent with code repository.                                                      #
  #############################################################################################################
  scpRevertChangesConfig:
    enable: true

  # SNS Subscriptions - Not configured (SNS alerts disabled)
  snsSubscriptions: []

  #############################################################################################################
  # Amazon Macie Configuration                                                                                #
  # DISABLED: Can be enabled later for sensitive data discovery                                               #
  # Cost: ~$1/account/month + data scanning costs                                                             #
  #                                                                                                           #
  # To re-enable:                                                                                             #
  #   macie:                                                                                                  #
  #     enable: true                                                                                          #
  #     excludeRegions: []                                                                                    #
  #     policyFindingsPublishingFrequency: FIFTEEN_MINUTES                                                    #
  #     publishSensitiveDataFindings: false                                                                   #
  #     publishPolicyFindings: true                                                                           #
  #############################################################################################################
  macie:
    enable: false
    excludeRegions: []
    policyFindingsPublishingFrequency: FIFTEEN_MINUTES
    publishSensitiveDataFindings: false
    publishPolicyFindings: true

  #############################################################################################################
  # Amazon GuardDuty Configuration                                                                            #
  # Threat detection service that analyzes logs for malicious activity.                                       #
  # - Base: VPC Flow Logs, CloudTrail, DNS logs                                                               #
  # - S3 Protection: Monitors S3 data plane events for anomalies                                              #
  # - EKS Protection: Monitors Kubernetes audit logs for suspicious activity                                  #
  # - Export: Findings exported to S3 for long-term storage/audit                                             #
  #############################################################################################################
  guardduty:
    enable: true
    excludeRegions: []
    s3Protection:
      enable: true # Monitors S3 access patterns for data exfiltration attempts
      excludeRegions: []
    eksProtection:
      enable: true # Monitors EKS Kubernetes audit logs for suspicious activity
    exportConfiguration:
      enable: true # Export findings to S3 for audit trail
      destinationType: S3
      exportFrequency: SIX_HOURS

  #############################################################################################################
  # AWS Security Hub Configuration                                                                            #
  # Centralized security findings and compliance dashboard.                                                   #
  # Enabled standard: NIST 800-53 Rev 5 only (reduces duplicate findings and cost)                            #
  #############################################################################################################
  securityHub:
    enable: true
    regionAggregation: true # Aggregates findings from all regions to home region
    excludeRegions: []
    standards:
      #########################################################################################################
      # NIST Special Publication 800-53 Revision 5                                                            #
      # Comprehensive security control framework used by federal agencies and enterprises.                    #
      # Reference: https://docs.aws.amazon.com/securityhub/latest/userguide/nist-standard.html                #
      #########################################################################################################
      - name: NIST Special Publication 800-53 Revision 5
        enable: true
        deploymentTargets:
          organizationalUnits:
            - Root
      #########################################################################################################
      # DISABLED: Other Security Hub Standards                                                                #
      # Removed to reduce duplicate findings and costs. NIST 800-53 R5 is comprehensive.                      #
      #                                                                                                       #
      # AWS Foundational Security Best Practices (FSBP):                                                      #
      #   - name: AWS Foundational Security Best Practices v1.0.0                                             #
      #     enable: true                                                                                      #
      #     deploymentTargets:                                                                                #
      #       organizationalUnits:                                                                            #
      #         - Root                                                                                        #
      #                                                                                                       #
      # CIS AWS Foundations Benchmark v3.0.0:                                                                 #
      #   - name: CIS AWS Foundations Benchmark v3.0.0                                                        #
      #     enable: true                                                                                      #
      #     deploymentTargets:                                                                                #
      #       organizationalUnits:                                                                            #
      #         - Root                                                                                        #
      #########################################################################################################

  #############################################################################################################
  # SSM Automation Documents                                                                                  #
  # REMOVED: Documents referenced deleted resources (ELB bucket, SSM role)                                    #
  #                                                                                                           #
  # Original documents:                                                                                       #
  #   - enable-elb-logging.yaml (referenced removed ELB log bucket)                                           #
  #   - attach-iam-instance-profile.yaml (referenced removed EC2-Default-SSM-Role)                            #
  #                                                                                                           #
  # To add SSM automation documents later:                                                                    #
  #   ssmAutomation:                                                                                          #
  #     documentSets:                                                                                         #
  #       - shareTargets:                                                                                     #
  #           organizationalUnits:                                                                            #
  #             - Root                                                                                        #
  #         documents:                                                                                        #
  #           - name: "{{ AcceleratorPrefix }}-My-Document"                                                   #
  #             template: ssm-documents/my-document.yaml                                                      #
  #############################################################################################################
  ssmAutomation:
    documentSets: []

###############################################################################################################
# AWS IAM Access Analyzer                                                                                     #
# Analyzes resource policies to identify unintended public or cross-account access.                           #
# Low cost, high value for security posture.                                                                  #
###############################################################################################################
accessAnalyzer:
  enable: true

###############################################################################################################
# AWS IAM Password Policy                                                                                     #
# Organization-wide password requirements for IAM users.                                                      #
# Note: Prefer IAM Identity Center over IAM users where possible.                                             #
###############################################################################################################
iamPasswordPolicy:
  allowUsersToChangePassword: true
  hardExpiry: false
  requireUppercaseCharacters: true
  requireLowercaseCharacters: true
  requireSymbols: true
  requireNumbers: true
  minimumPasswordLength: 14
  passwordReusePrevention: 24
  maxPasswordAge: 90

###############################################################################################################
# CloudWatch Alarms and Metrics                                                                               #
# Not configured - using SecurityHub for security monitoring                                                  #
###############################################################################################################
cloudWatch:
  metricSets: []
  alarmSets: []

###############################################################################################################
# AWS Config Configuration                                                                                    #
# In Control Tower environment:                                                                               #
#   - CT enables Config across all enrolled accounts                                                          #
#   - LZA enables Config in management account                                                                #
#   - SecurityHub NIST 800-53 R5 creates its own Config rules automatically                                   #
#                                                                                                             #
# Config Aggregation: Enabled in Audit account for centralized compliance view across all accounts.           #
#                                                                                                             #
# The rules below are ADDITIONAL rules not covered by SecurityHub standards.                                  #
###############################################################################################################
awsConfig:
  enableConfigurationRecorder: true
  enableDeliveryChannel: true
  useServiceLinkedRole: true
  aggregation:
    enable: true
    delegatedAdminAccount: Audit # Centralized compliance view in your Config account
  ruleSets:
    ###########################################################################################################
    # Config Rules - All Accounts (except Management)                                                         #
    # These are additional rules beyond SecurityHub NIST 800-53 R5 controls.                                  #
    ###########################################################################################################
    - deploymentTargets:
        organizationalUnits:
          - Root
        excludedAccounts:
          - Management
      rules:
        # IAM Governance
        - name: "{{ AcceleratorPrefix }}-iam-user-group-membership-check"
          description: Ensures IAM users belong to at least one IAM group for better access management
          complianceResourceTypes:
            - AWS::IAM::User
          identifier: IAM_USER_GROUP_MEMBERSHIP_CHECK
          tags:
            - key: Accelerator
              value: "{{ AcceleratorPrefix }}"

        # S3 Security
        - name: "{{ AcceleratorPrefix }}-s3-bucket-policy-grantee-check"
          description: Validates S3 bucket policies don't grant access to unintended principals
          complianceResourceTypes:
            - AWS::S3::Bucket
          identifier: S3_BUCKET_POLICY_GRANTEE_CHECK
          tags:
            - key: Accelerator
              value: "{{ AcceleratorPrefix }}"

        # Cost Optimization
        - name: "{{ AcceleratorPrefix }}-ec2-volume-inuse-check"
          description: Identifies unattached EBS volumes (cost optimization)
          inputParameters:
            deleteOnTermination: "TRUE"
          complianceResourceTypes:
            - AWS::EC2::Volume
          identifier: EC2_VOLUME_INUSE_CHECK
          tags:
            - key: Accelerator
              value: "{{ AcceleratorPrefix }}"

        # Security Monitoring
        - name: "{{ AcceleratorPrefix }}-guardduty-non-archived-findings"
          description: Alerts when GuardDuty findings remain unaddressed beyond thresholds
          inputParameters:
            daysHighSev: "1"
            daysLowSev: "30"
            daysMediumSev: "7"
          identifier: GUARDDUTY_NON_ARCHIVED_FINDINGS
          tags:
            - key: Accelerator
              value: "{{ AcceleratorPrefix }}"

        # Application Best Practices
        - name: "{{ AcceleratorPrefix }}-lambda-dlq-check"
          description: Ensures Lambda functions have dead-letter queues configured
          complianceResourceTypes:
            - AWS::Lambda::Function
          identifier: LAMBDA_DLQ_CHECK
          tags:
            - key: Accelerator
              value: "{{ AcceleratorPrefix }}"

        - name: "{{ AcceleratorPrefix }}-api-gw-cache-enabled-and-encrypted"
          description: Validates API Gateway cache is encrypted when enabled
          complianceResourceTypes:
            - AWS::ApiGateway::Stage
          identifier: API_GW_CACHE_ENABLED_AND_ENCRYPTED
          tags:
            - key: Accelerator
              value: "{{ AcceleratorPrefix }}"

        # Big Data Security (for potential EMR usage)
        - name: "{{ AcceleratorPrefix }}-emr-kerberos-enabled"
          description: Ensures EMR clusters use Kerberos authentication
          identifier: EMR_KERBEROS_ENABLED
          tags:
            - key: Accelerator
              value: "{{ AcceleratorPrefix }}"

    ###########################################################################################################
    # Config Rules - Management Account Only                                                                  #
    # Control Tower cannot deploy Config rules in the Management account, so LZA deploys them.                #
    # Minimal set to avoid clutter in management account.                                                     #
    ###########################################################################################################
    - deploymentTargets:
        accounts:
          - Management
      rules:
        - name: "{{ AcceleratorPrefix }}-iam-user-group-membership-check"
          description: Ensures IAM users belong to at least one IAM group
          complianceResourceTypes:
            - AWS::IAM::User
          identifier: IAM_USER_GROUP_MEMBERSHIP_CHECK
          tags:
            - key: Accelerator
              value: "{{ AcceleratorPrefix }}"

        - name: "{{ AcceleratorPrefix }}-guardduty-non-archived-findings"
          description: Alerts when GuardDuty findings remain unaddressed
          inputParameters:
            daysHighSev: "1"
            daysLowSev: "30"
            daysMediumSev: "7"
          identifier: GUARDDUTY_NON_ARCHIVED_FINDINGS
          tags:
            - key: Accelerator
              value: "{{ AcceleratorPrefix }}"

###############################################################################################################
# REMOVED: Config Rules with Broken References                                                                #
# The following rules were removed due to references to deleted resources:                                    #
#                                                                                                             #
# Rules referencing disabled services:                                                                        #
#   - ebs-in-backup-plan (backups disabled)                                                                   #
#   - rds-in-backup-plan (backups disabled)                                                                   #
#   - aurora-resources-protected-by-backup-plan (backups disabled)                                            #
#   - backup-recovery-point-encrypted (backups disabled)                                                      #
#   - backup-plan-min-frequency-and-min-retention-check (backups disabled)                                    #
#   - backup-recovery-point-manual-deletion-disabled (backups disabled)                                       #
#   - ec2-resources-protected-by-backup-plan (backups disabled)                                               #
#   - secretsmanager-using-cmk (not enforcing CMK)                                                            #
#                                                                                                             #
# Rules redundant with Control Tower:                                                                         #
#   - cloudtrail-enabled (CT manages organization trail)                                                      #
#   - cloudtrail-security-trail-enabled (CT manages organization trail)                                       #
#                                                                                                             #
# Rules with broken remediation:                                                                              #
#   - ec2-instance-profile-attached (references removed EC2-Default-SSM-Role)                                 #
#   - elb-logging-enabled (references removed ELB log bucket)                                                 #
#                                                                                                             #
# Other removed rules:                                                                                        #
#   - ec2-instance-detailed-monitoring-enabled (optional, has cost)                                           #
#   - ec2-instances-in-vpc (covered by SecurityHub)                                                           #
#   - securityhub-enabled (Management account only, redundant)                                                #
#   - cloudtrail-s3-dataevents-enabled (Management account only, optional)                                    #
#   - iam-group-has-users-check (Management account only, optional)                                           #
#   - internet-gateway-authorized-vpc-only (Management account only, networking external)                     #
#   - iam-no-inline-policy-check (Management account only, optional)                                          #
#   - cloudwatch-log-group-encrypted (Management account only, not enforcing CMK)                             #
#   - sagemaker-notebook-instance-kms-key-configured (Management account only, not enforcing CMK)             #
#   - no-unrestricted-route-to-igw (Management account only, networking external)                             #
###############################################################################################################
